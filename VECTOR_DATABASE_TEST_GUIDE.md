# ğŸ—„ï¸ å‘é‡æ•°æ®åº“æµ‹è¯•æŒ‡å—

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

ç¡®è®¤åª’ä½“æ–‡ä»¶ä¸Šä¼ åï¼Œå›¾åƒembeddingå’Œæ–‡æœ¬embeddingèƒ½å¤Ÿæ­£ç¡®å­˜å‚¨åˆ°Qdrantå‘é‡æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”æœç´¢åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚

---

## ğŸ§ª æµ‹è¯•ç¯å¢ƒå‡†å¤‡

### 1. ç¡®è®¤æœåŠ¡çŠ¶æ€

ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
- âœ… Qdrantå‘é‡æ•°æ®åº“ (ç«¯å£6333)
- âœ… åç«¯APIæœåŠ¡ (ç«¯å£5000)
- âœ… å‰ç«¯æœåŠ¡ (ç«¯å£3000)
- âœ… é˜¿é‡Œäº‘DashScope API Keyå·²é…ç½®

### 2. å¯åŠ¨ç›‘æ§è„šæœ¬

```bash
cd backend
python3 test_media_embedding_flow.py
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
- æ£€æŸ¥å‘é‡æ•°æ®åº“å½“å‰çŠ¶æ€
- å®æ—¶ç›‘æ§å‘é‡æ•°é‡å˜åŒ–
- æ˜¾ç¤ºæ–°å¢å‘é‡çš„è¯¦ç»†ä¿¡æ¯
- æµ‹è¯•æœç´¢åŠŸèƒ½

---

## ğŸ“Š æµ‹è¯•æ­¥éª¤

### é˜¶æ®µ1: åŸºç¡€è¿æ¥æµ‹è¯•

1. **è¿è¡ŒåŸºç¡€æµ‹è¯•**
   ```bash
   cd backend
   python3 -c "
   import asyncio
   from app.database.qdrant_manager import init_qdrant, get_qdrant_manager
   
   async def test():
       await init_qdrant()
       manager = get_qdrant_manager()
       info = await manager.get_collection_info()
       print('å‘é‡æ•°æ®åº“çŠ¶æ€:', info)
   
   asyncio.run(test())
   "
   ```

2. **æœŸæœ›ç»“æœ**
   - âœ… è¿æ¥æˆåŠŸ
   - âœ… é›†åˆ `media_embeddings` å­˜åœ¨
   - âœ… æ˜¾ç¤ºå½“å‰å‘é‡æ•°é‡

### é˜¶æ®µ2: æ–‡ä»¶ä¸Šä¼ æµ‹è¯•

1. **å‡†å¤‡æµ‹è¯•æ–‡ä»¶**
   - é€‰æ‹©2-3å¼ ä¸åŒç±»å‹çš„å›¾ç‰‡æ–‡ä»¶
   - æ–‡ä»¶å¤§å° < 500MB
   - æ”¯æŒæ ¼å¼ï¼š.jpg, .jpeg, .png, .heic, .webp

2. **æ‰§è¡Œä¸Šä¼ æ“ä½œ**
   - é€šè¿‡å‰ç«¯ç•Œé¢ (http://localhost:3000) ç™»å½•
   - ä¸Šä¼ å‡†å¤‡å¥½çš„æµ‹è¯•æ–‡ä»¶
   - è§‚å¯Ÿä¸Šä¼ è¿›åº¦å’ŒæˆåŠŸæç¤º

3. **ç›‘æ§å‘é‡å˜åŒ–**
   - æŸ¥çœ‹ `test_media_embedding_flow.py` è„šæœ¬è¾“å‡º
   - åº”è¯¥çœ‹åˆ°å‘é‡æ•°é‡å®æ—¶å¢åŠ 
   - æ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå‘é‡ç‚¹ï¼ˆåŒ…å«æ–‡æœ¬å’Œå›¾åƒembeddingï¼‰

### é˜¶æ®µ3: å‘é‡å­˜å‚¨éªŒè¯

**æœŸæœ›çš„ç›‘æ§è¾“å‡ºç¤ºä¾‹ï¼š**
```
ğŸ“ˆ [22:25:30] å‘é‡æ•°é‡å˜åŒ–: 0 â†’ 1 (+1)
   ğŸ“‹ æœ€æ–°çš„å‘é‡è®°å½•:
     1. ID: 123456789012345678
        æ–‡ä»¶: /media/photos/2025-06-09/IMG_4656_20250609222530.jpeg
        ç±»å‹: image
        æ—¶é—´: 2025-06-09T22:25:30
```

**æ£€æŸ¥è¦ç‚¹ï¼š**
- âœ… æ¯ä¸Šä¼ ä¸€ä¸ªæ–‡ä»¶ï¼Œå‘é‡æ•°é‡ +1
- âœ… å‘é‡è®°å½•åŒ…å«æ­£ç¡®çš„æ–‡ä»¶è·¯å¾„
- âœ… æ–‡ä»¶ç±»å‹æ­£ç¡®è¯†åˆ«
- âœ… ä¸Šä¼ æ—¶é—´å‡†ç¡®è®°å½•

### é˜¶æ®µ4: æœç´¢åŠŸèƒ½æµ‹è¯•

1. **æ–‡æœ¬æœç´¢æµ‹è¯•**
   - åœ¨å‰ç«¯æœç´¢æ¡†è¾“å…¥ï¼š"ç…§ç‰‡"ã€"å›¾åƒ"ã€"é£æ™¯"ç­‰å…³é”®è¯
   - è§‚å¯Ÿæœç´¢ç»“æœæ˜¯å¦è¿”å›ç›¸å…³æ–‡ä»¶

2. **åç«¯æœç´¢APIæµ‹è¯•**
   ```bash
   curl -X POST "http://localhost:5000/api/v1/search/text" \
   -H "Content-Type: application/json" \
   -H "Authorization: Bearer YOUR_TOKEN" \
   -d '{"query": "ç…§ç‰‡", "limit": 5}'
   ```

3. **æœŸæœ›ç»“æœ**
   - âœ… æœç´¢è¿”å›ç›¸å…³æ–‡ä»¶
   - âœ… ç›¸ä¼¼åº¦åˆ†æ•°åˆç† (0.0-1.0)
   - âœ… ç»“æœæŒ‰ç›¸ä¼¼åº¦æ’åº

---

## ğŸ” è¯¦ç»†éªŒè¯æ–¹æ³•

### æ–¹æ³•1: é€šè¿‡ç›‘æ§è„šæœ¬

**å®æ—¶ç›‘æ§ä¸Šä¼ è¿‡ç¨‹ï¼š**
1. è¿è¡Œ `test_media_embedding_flow.py`
2. ä¿æŒè„šæœ¬è¿è¡ŒçŠ¶æ€
3. é€šè¿‡å‰ç«¯ä¸Šä¼ æ–‡ä»¶
4. è§‚å¯Ÿè„šæœ¬è¾“å‡ºçš„å˜åŒ–

### æ–¹æ³•2: æ‰‹åŠ¨æ£€æŸ¥å‘é‡æ•°æ®åº“

```bash
cd backend
python3 -c "
import asyncio
from app.database.qdrant_manager import get_qdrant_manager, init_qdrant

async def check_vectors():
    await init_qdrant()
    manager = get_qdrant_manager()
    
    # è·å–é›†åˆä¿¡æ¯
    info = await manager.get_collection_info()
    print(f'ğŸ“Š é›†åˆç»Ÿè®¡: {info}')
    
    # æœç´¢æ‰€æœ‰å‘é‡
    dummy_vector = [0.0] * 1024
    results = await manager.search_by_text(dummy_vector, limit=10, score_threshold=0.0)
    
    print(f'ğŸ“‹ å‘é‡è®°å½• ({len(results)} ä¸ª):')
    for i, result in enumerate(results):
        metadata = result.get('metadata', {})
        print(f'  {i+1}. {metadata.get(\"file_path\", \"N/A\")}')
        print(f'     ç±»å‹: {metadata.get(\"file_type\", \"N/A\")}')
        print(f'     æ—¶é—´: {metadata.get(\"upload_time\", \"N/A\")}')

asyncio.run(check_vectors())
"
```

### æ–¹æ³•3: æœç´¢åŠŸèƒ½éªŒè¯

```bash
cd backend
python3 -c "
import asyncio
from app.services.vector_storage_service import get_vector_storage_service

async def test_search():
    service = get_vector_storage_service()
    
    # æµ‹è¯•ä¸åŒæœç´¢è¯
    test_queries = ['ç…§ç‰‡', 'å›¾åƒ', 'é£æ™¯', 'äººç‰©', 'åŠ¨ç‰©']
    
    for query in test_queries:
        results = await service.search_by_text(query, limit=3)
        print(f'ğŸ” æœç´¢ \"{query}\": {len(results)} ä¸ªç»“æœ')
        
        for i, result in enumerate(results):
            metadata = result.get('metadata', {})
            score = result.get('score', 0)
            print(f'  {i+1}. {metadata.get(\"file_path\", \"N/A\")} (åˆ†æ•°: {score:.4f})')

asyncio.run(test_search())
"
```

---

## âœ… æˆåŠŸæ ‡å‡†

### å‘é‡å­˜å‚¨æˆåŠŸçš„æ ‡å¿—ï¼š

1. **æ•°é‡ä¸€è‡´æ€§**
   - ä¸Šä¼ Nä¸ªæ–‡ä»¶ = å‘é‡æ•°æ®åº“ä¸­æœ‰Nä¸ªå‘é‡ç‚¹

2. **å…ƒæ•°æ®å®Œæ•´æ€§**
   - æ¯ä¸ªå‘é‡åŒ…å«å®Œæ•´çš„æ–‡ä»¶ä¿¡æ¯
   - æ–‡ä»¶è·¯å¾„ã€ç±»å‹ã€æ—¶é—´ç­‰ä¿¡æ¯å‡†ç¡®

3. **æœç´¢åŠŸèƒ½æ­£å¸¸**
   - æ–‡æœ¬æœç´¢èƒ½è¿”å›ç›¸å…³ç»“æœ
   - ç›¸ä¼¼åº¦åˆ†æ•°åˆç†
   - å“åº”æ—¶é—´ < 2ç§’

4. **embeddingè´¨é‡**
   - å‘é‡ç»´åº¦ = 1024
   - å‘é‡å€¼åœ¨åˆç†èŒƒå›´å†…ï¼ˆé€šå¸¸ -1 åˆ° 1ï¼‰

### å¸¸è§é—®é¢˜æ’æŸ¥ï¼š

**é—®é¢˜1: å‘é‡æ•°é‡ä¸å¢åŠ **
- æ£€æŸ¥embeddingæœåŠ¡æ˜¯å¦æ­£å¸¸å·¥ä½œ
- æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- ç¡®è®¤é˜¿é‡Œäº‘API Keyé…ç½®æ­£ç¡®

**é—®é¢˜2: æœç´¢æ— ç»“æœ**
- ç¡®è®¤å‘é‡æ•°æ®å·²æˆåŠŸå­˜å‚¨
- æ£€æŸ¥æœç´¢é˜ˆå€¼è®¾ç½®
- éªŒè¯æœç´¢æŸ¥è¯¢å‘é‡ç”Ÿæˆ

**é—®é¢˜3: å‘é‡ä¿¡æ¯ä¸å®Œæ•´**
- æ£€æŸ¥åª’ä½“æ–‡ä»¶ä¸Šä¼ æ—¶çš„å…ƒæ•°æ®æå–
- ç¡®è®¤æ–‡ä»¶è·¯å¾„å’Œæ—¶é—´ä¿¡æ¯æ­£ç¡®

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†

### é¢„æœŸæ€§èƒ½æŒ‡æ ‡ï¼š

- **ä¸Šä¼ å¤„ç†æ—¶é—´**: æ¯ä¸ªæ–‡ä»¶ < 10ç§’
- **æœç´¢å“åº”æ—¶é—´**: < 2ç§’
- **å‘é‡å­˜å‚¨å»¶è¿Ÿ**: < 5ç§’
- **å†…å­˜ä½¿ç”¨**: Qdrantè¿›ç¨‹ < 1GB

### æ‰©å®¹æµ‹è¯•ï¼š

å¯ä»¥æµ‹è¯•æ‰¹é‡ä¸Šä¼ å¤šä¸ªæ–‡ä»¶ï¼ŒéªŒè¯ç³»ç»Ÿåœ¨è´Ÿè½½ä¸‹çš„è¡¨ç°ï¼š

1. å‡†å¤‡10-20ä¸ªæµ‹è¯•æ–‡ä»¶
2. æ‰¹é‡ä¸Šä¼ 
3. ç›‘æ§ç³»ç»Ÿèµ„æºä½¿ç”¨
4. éªŒè¯æ‰€æœ‰æ–‡ä»¶çš„å‘é‡éƒ½æ­£ç¡®å­˜å‚¨

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–

å®ŒæˆåŸºç¡€æµ‹è¯•åï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **æœç´¢ä½“éªŒä¼˜åŒ–**
   - è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼
   - ä¼˜åŒ–æœç´¢ç»“æœæ’åº

2. **æ€§èƒ½ä¼˜åŒ–**
   - é…ç½®Qdrantç´¢å¼•å‚æ•°
   - ä¼˜åŒ–embeddingæ‰¹å¤„ç†

3. **åŠŸèƒ½æ‰©å±•**
   - æ·»åŠ æŒ‰æ–‡ä»¶ç±»å‹è¿‡æ»¤
   - æ”¯æŒæ—¶é—´èŒƒå›´æœç´¢
   - å®ç°ç›¸ä¼¼å›¾ç‰‡æ¨è

ä½¿ç”¨è¿™ä¸ªæµ‹è¯•æŒ‡å—ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿå…¨é¢éªŒè¯å‘é‡æ•°æ®åº“çš„åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ğŸš€ 