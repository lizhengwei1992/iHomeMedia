# 家庭媒体应用 - 开发和测试指南

## 🚀 快速启动

### 启动所有服务
```bash
./start-app.sh
```

### 停止所有服务
```bash
./stop-app.sh
```

## 📋 启动模式说明

运行 `./start-app.sh` 后，您可以选择以下模式：

| 选项 | 模式 | 说明 | 媒体文件支持 | 适用场景 |
|-----|------|------|-------------|----------|
| **1** | 仅启动后端 | 只启动API服务 | ❌ | 后端开发/测试 |
| **2** | 仅启动前端 | 只启动前端代理 | ✅ | 前端独立测试 |
| **3** | 前端+后端 | **推荐模式** | ✅ | **日常使用** |
| **4** | 开发模式 | 代理服务器+后端 | ✅ | **完整功能开发** |
| **5** | Vite开发模式 | 热更新前端 | ❌ | 纯前端代码开发 |
| **6** | 特权模式 | 自动修复权限 | ✅ | 权限问题修复 |

## 🛑 停止模式说明

运行 `./stop-app.sh` 后，您可以选择以下操作：

| 选项 | 操作 | 说明 | 推荐度 |
|-----|------|------|-------|
| **1** | 优雅停止所有服务 | **推荐方式** | ⭐⭐⭐⭐⭐ |
| **2** | 强制停止所有服务 | 立即终止所有进程 | ⭐⭐⭐ |
| **3** | 仅停止后端 | 只停止uvicorn服务 | ⭐⭐⭐⭐ |
| **4** | 仅停止前端 | 停止前端和Node.js服务 | ⭐⭐⭐⭐ |
| **5** | 清理端口 | 强制清理3000和5000端口 | ⭐⭐ |
| **6** | 取消操作 | 不做任何操作 | ⭐⭐⭐⭐⭐ |

## 🔧 开发工作流

### 典型开发流程
```bash
# 1. 停止现有服务
./stop-app.sh

# 2. 启动开发环境
./start-app.sh
# 选择选项 4 (开发模式)

# 3. 开发完成后停止
./stop-app.sh
# 选择选项 1 (优雅停止)
```

### 前端开发流程
```bash
# 如果只需要修改前端代码(支持媒体文件预览)
./start-app.sh
# 选择选项 4 (开发模式)
# 修改代码后运行: cd frontend && npm run build

# 如果需要热更新(不支持媒体文件预览)  
./start-app.sh
# 选择选项 5 (Vite开发模式)
```

### 后端开发流程
```bash
# 如果只需要测试后端API
./start-app.sh
# 选择选项 1 (仅启动后端)
# 后端会在代码修改时自动重载
```

## 🌐 服务地址

| 服务 | 地址 | 说明 |
|-----|------|------|
| **前端应用** | http://localhost:3000 | 主要访问地址 |
| **后端API** | http://localhost:5000 | API文档地址 |
| **API文档** | http://localhost:5000/docs | Swagger UI |
| **媒体文件** | http://localhost:3000/media/ | 通过前端代理访问 |
| **缩略图** | http://localhost:3000/thumbnails/ | 通过前端代理访问 |

## 📁 重要目录

```
family_media_app/
├── backend/                 # 后端代码
│   ├── app/                # FastAPI应用
│   ├── start-backend.sh    # 后端启动脚本
│   └── requirements.txt    # Python依赖
├── frontend/               # 前端代码  
│   ├── src/               # React源代码
│   ├── dist/              # 构建输出
│   ├── server.py          # 代理服务器
│   ├── start-frontend.sh  # 前端启动脚本
│   └── package.json       # Node.js依赖
├── /media/                # 媒体文件存储目录
│   ├── photos/           # 照片存储
│   ├── videos/           # 视频存储
│   └── thumbnails/       # 缩略图存储
├── start-app.sh          # 主启动脚本
└── stop-app.sh           # 停止脚本
```

## 🐛 常见问题

### 1. 端口被占用
```bash
# 使用停止脚本清理
./stop-app.sh
# 选择选项 5 (清理端口)
```

### 2. 权限问题
```bash
# 使用特权模式启动
./start-app.sh
# 选择选项 6 (特权模式)
```

### 3. 媒体文件无法预览
- 确保使用了支持媒体文件代理的模式（选项3、4、6）
- 避免使用选项5（Vite开发模式）来访问媒体文件

### 4. 服务无法停止
```bash
# 使用强制停止
./stop-app.sh
# 选择选项 2 (强制停止)
```

### 5. 前端代码修改不生效
```bash
# 重新构建前端
cd frontend
npm run build

# 或者使用Vite开发模式
./start-app.sh
# 选择选项 5 (热更新)
```

## 💡 开发技巧

### 快速重启
```bash
./stop-app.sh && ./start-app.sh
```

### 查看服务状态
```bash
# 查看当前运行的服务
ps aux | grep -E "(uvicorn|server\.py|node.*vite)"

# 查看端口占用
lsof -i:3000,5000
```

### 日志查看
```bash
# 后端日志在前台显示
# 前端代理服务器日志也在前台显示
# 如需后台运行，可使用 nohup 或 screen
```

## 📚 相关文档

- [后端API文档](http://localhost:5000/docs) - Swagger UI
- [前端组件文档](frontend/README.md) - React组件说明
- [部署文档](DEPLOYMENT.md) - 生产环境部署

## 🔧 故障排除

如果遇到任何问题：

1. **首先尝试**: `./stop-app.sh` → `./start-app.sh`
2. **检查日志**: 查看终端输出的错误信息
3. **检查权限**: 确保有权限访问 `/media` 目录
4. **清理端口**: 使用停止脚本的选项5清理端口
5. **重新构建**: `cd frontend && npm run build`

需要帮助时，请提供：
- 使用的启动模式
- 错误信息截图
- 服务状态输出 